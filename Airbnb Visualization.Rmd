```{r}
library(randomForest)
library(tidyverse)
library(geosphere)
library(parallel)
library(corrgram)
library(corrplot)
library(mltools)
library(data.table)
library(glmnet)
library(boot) #for cross validation

#Visualization
library(tidyverse)
library(sf)
library(leaflet)
library(viridis)
```

```{r}
airbnb_all = read.csv('airbnb_wdistances.csv')
nysubways = read.csv('nyc-transit-subway-entrance-and-exit-data.csv')

# Checking for NAs in all columns

sapply(airbnb_all, function(x) sum(is.na(x)))

# Replacing NAs in reviews_per_month with 0

airbnb_all = airbnb_all %>% mutate(reviews_per_month = replace_na(reviews_per_month, 0))

summary(log(airbnb_all$price))



# Getting rid of rows with price = 0  (Does not help i analysis)

airbnb_all =(airbnb_all[(airbnb_all$price != 0), ])



# Now we get rid of the columns which have no bearing on predicting price

airbnb_all %>% glimpse()

min_nights_365 = airbnb_all %>% filter(minimum_nights <= 365)
min_nights_365 #48870 out of 48884

ggplot(min_nights_365,aes(x = minimum_nights)) + geom_histogram() + scale_x_continuous(breaks = seq(0,365, by = 40)) # most nights within 30 

min_nights_30 = airbnb_all %>% filter(minimum_nights <= 30) #48137

# (48870-48137)/48884 = 1.5% of the data has min_nights > 30. Hence we get rid of those rows


airbnb_model = airbnb_all %>% filter(minimum_nights <= 30)
```

# Airbnb new model
```{r}
airbnb_new_model = airbnb_model %>% filter(price <= 269)
```

#Airbnb data with price ranges
```{r}
airbnb_all_priceClasses = airbnb_all %>%
  mutate(price_class = case_when(
    price < 69 ~ "affordable",
    (price >= 69 & price < 106) ~ "medium",
    (price >= 106 & price < 175) ~ "expensive",
    (price >= 175) ~ "very_expensive",
    TRUE ~ "NA"
  )
)
#airbnb_all_priceClasses$price_class %>% table()
```

#Leaflet map of neighborhood groups + subway locations

```{r}
pal = colorFactor(palette = c("red","green","blue", "purple","yellow"), domain = airbnb_all$neighbourhood_group)

leaflet(data = airbnb_all) %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels) %>% 
  addCircleMarkers(~longitude, ~latitude, color = ~pal(neighbourhood_group), weight = 1, radius = 1, fillOpacity = 0.1, opacity = 0.1,
                   label = paste("Name:", airbnb$name)) %>% 
  addLegend("bottomright", pal = pal, values = ~ neighbourhood_group,
            title = "Neighborhood groups", opacity = 1) %>%  addCircleMarkers(data = nysubways, ~ Station.Longitude, ~Station.Latitude, color = "orange", weight = 1, radius = 1, fillOpacity = 0.1, opacity = 1,
                   label = paste("Name:", nysubways$Station.Name))
```

#Leaflet map of subway locations

```{r}
glimpse(nysubways)
table(nysubways$Station.Name)

#pal = colorFactor(palette = c("red","green","blue", "purple","yellow"), domain = airbnb_all$neighbourhood_group)

leaflet(data =nysubways) %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels) %>% 
  addCircleMarkers(~ Station.Longitude, ~Station.Latitude, color = "orange", weight = 1, radius = 1, fillOpacity = 0.1, opacity = 0.1,
                   label = paste("Name:", nysubways$Station.Name))
```

#Leaflet map of price classes with subway locations

```{r}
#airbnb_all_priceClasses
pal = colorFactor(palette = c("green","yellow","orange","red"), domain = airbnb_all_priceClasses$price_class)

leaflet(data = airbnb_all_priceClasses) %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels) %>% 
  addCircleMarkers(~longitude, ~latitude, color = ~pal(price_class),
                   weight = 1,
                   radius = 1,
                   fillOpacity = 0.1,
                   opacity = 0.1,
                   label = paste(airbnb_all_priceClasses$price))%>% 
  addLegend("bottomright", pal = pal, values = ~ price_class,
            title = "Price ranges", opacity = 1) %>% addCircleMarkers(data = nysubways, ~ Station.Longitude, ~Station.Latitude, color = "white", weight = 1, radius = 1, fillOpacity = 0.1, opacity = 1,
                   label = paste("Name:", nysubways$Station.Name))
```
